#!/bin/bash
set -e

BUILD_GTEST=0 # download and build gtest from source
BUILD_TESTS=1 # build unit tests
HAVE_GPU=0

if test $(ls /dev/ | grep nvidia | wc -l) -gt 0; then
    HAVE_GPU=1
fi

parse_args() {
    for i in "$@"; do
        case $i in
        --build-gtest)
            BUILD_GTEST=1
            ;;
        --no-tests)
            BUILD_TESTS=0
            ;;
        --no-gpu)
            HAVE_GPU=0
            ;;
        *)
            echo "unknown argument $1"
            exit
            ;;
        esac
    done
}

CMAKE_FLAGS=

add_cmake_flag() {
    echo "usinig $1=$2"
    CMAKE_FLAGS="$CMAKE_FLAGS -D$1=$2"
}

add_cmake_flags() {
    if [ ! -z ${GTEST_GIT_URL} ]; then
        add_cmake_flag GTEST_GIT_URL ${GTEST_GIT_URL}
    fi

    if [ ! -z ${STDTRACER_GIT_URL} ]; then
        add_cmake_flag STDTRACER_GIT_URL ${STDTRACER_GIT_URL}
    fi

    add_cmake_flag CMAKE_BUILD_TYPE Release
    add_cmake_flag PYTHON $(which python3)
    add_cmake_flag LIBRARY_OUTPUT_PATH $(pwd)/lib
    add_cmake_flag CMAKE_RUNTIME_OUTPUT_DIRECTORY $(pwd)/bin
    add_cmake_flag CMAKE_MODULE_PATH $(pwd)/cmake
    # add_cmake_flag CMAKE_VERBOSE_MAKEFILE 1
    # add_cmake_flag CMAKE_EXPORT_COMPILE_COMMANDS 1

    add_cmake_flag KUNGFU_BUILD_GTEST ${BUILD_GTEST}
    add_cmake_flag KUNGFU_BUILD_TESTS ${BUILD_TESTS}
    add_cmake_flag KUNGFU_HAVE_GPU ${HAVE_GPU}
}

parse_args $@
add_cmake_flags
cmake . $CMAKE_FLAGS
